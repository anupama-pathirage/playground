configurations {
    utils { }
    controller {
        transitive = false
    }
    gists_api {
        transitive = false
    }
}

dependencies {
    utils project(":utils:redis-client")
}

task copyRedisClient(type: Copy) {
    dependsOn(':utils:redis-client:build')
    from configurations.utils
    into "libs" 
}

def inputFiles = [
    project.file("Ballerina.toml"),
    project.file("Ballerina.lock"),
    project.file("src")
]

task cloudBuild(type: Exec) {
    inputs.files(inputFiles)
    commandLine "gcloud", "builds", "submit", "--config", "cloudbuild.yaml", "."
}

def env = System.getenv()
def gcpProjectID = env["BPG_GCP_PROJECT_ID"]

task build(type: Exec) {
    dependsOn copyRedisClient
    inputs.files(inputFiles)
    outputs.cacheIf { true }
    outputs.dir("target")
    commandLine 'ballerina', 'build', '-a'
}

artifacts.add("controller", project.file("target/bin/playground_controller.jar"))
artifacts.add("gists_api", project.file("target/bin/playground_gists.jar"))
